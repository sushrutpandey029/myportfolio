{% extends "base/base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/services.css') }}">
{% endblock %}

{% block content %}
<!-- Animated Background -->
<div class="bg-animated"></div>

<!-- Main Content -->
<div class="relative z-10 px-4">
    <div class="max-w-7xl mx-auto">

        <!-- Hero Section -->
        <section class="hero-section scroll-reveal">
            <h1 class="hero-title">
                <span class="hero-subtitle-muted">Professional</span><br>
                <span class="gradient-text">Services</span><br>
                <span class="hero-subtitle-bright">For Your Business</span>
            </h1>
            <p class="hero-description">
                Discover premium solutions crafted for your success.
                <span class="hero-description-highlight">Quality delivered on time.</span>
            </p>
        </section>

        <!-- Search & Filter Section -->
        <section class="search-section scroll-reveal scroll-delay-1">
            <!-- Search Bar -->
            <div class="search-wrapper">
                <div class="search-glow"></div>
                <span class="search-icon material-symbols-outlined">search</span>
                <input type="text" id="search-input" class="search-input" placeholder="Search for services...">
            </div>

            <!-- Category Pills -->
            <div class="category-pills">
                <button class="category-pill active" data-category="all" onclick="selectCategory(this, 'all')">
                    <span class="category-pill-content">
                        <span class="material-symbols-outlined category-icon">grid_view</span>
                        All Services
                    </span>
                </button>
                {% for cat in categories %}
                <button class="category-pill" data-category="{{ cat|lower }}"
                    onclick="selectCategory(this, '{{ cat|lower }}')">
                    <span class="category-pill-content">{{ cat }}</span>
                </button>
                {% endfor %}
            </div>

            <!-- Results Count -->
            <div class="results-info">
                <p id="results-count"></p>
            </div>
        </section>

        <!-- Services Grid -->
        <section class="scroll-reveal scroll-delay-2">
            <div id="services-grid" class="services-grid">
                <!-- Loading State -->
                <div id="loading" class="grid-full-width">
                    <div class="loading-state">
                        <div class="loader"></div>
                        <p class="loading-text">Loading amazing services...</p>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-icon">
                    <span class="material-symbols-outlined">search_off</span>
                </div>
                <h3 class="empty-title">No Services Found</h3>
                <p class="empty-description">
                    We couldn't find any services matching your criteria.<br>
                    Try adjusting your search or browse all categories.
                </p>
                <button class="btn-view" id="show-all-btn">
                    <span>Show All Services</span>
                    <span class="material-symbols-outlined btn-icon">refresh</span>
                </button>
            </div>
        </section>

        <!-- Pagination -->
        <div id="pagination" class="pagination"></div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let allServices = [];
        let filteredServices = [];
        let selectedCategory = 'all';
        const servicesPerPage = 6;
        let currentPage = 1;

        // Fetch Services Data
        async function fetchServices() {
            try {
                const response = await fetch('{{ url_for("services.services_data") }}');
                const data = await response.json();
                allServices = data.services;
                filteredServices = [...allServices];

                document.getElementById('loading')?.remove();
                renderServices();
                updateResultsCount();
                initScrollReveal();
            } catch (error) {
                console.error('Error:', error);
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.innerHTML = '<p class="error-message">Failed to load services. Please refresh the page.</p>';
                }
            }
        }

        // Create Service Card
        function createServiceCard(service) {
            const card = document.createElement('div');
            card.className = 'scroll-reveal';

            const imageUrl = service.image_url ? '/static/' + service.image_url : 'https://images.unsplash.com/photo-1551434678-e076c223a692?w=800&q=80';

            card.innerHTML = `
            <article class="service-card">
                <div class="service-image-wrapper">
                    <img src="${imageUrl}" alt="${service.title}" class="service-image">
                    <div class="service-badges">
                        <span class="badge badge-category">${service.category}</span>
                        <span class="badge badge-premium">
                            <span class="material-symbols-outlined badge-icon">verified</span>
                            Premium
                        </span>
                    </div>
                </div>
                <div class="service-content">
                    <h3 class="service-title">${service.title}</h3>
                    <p class="service-description">
                        ${service.description.substring(0, 130)}${service.description.length > 130 ? '...' : ''}
                    </p>
                    <div class="service-meta">
                        <div class="meta-item">
                            <span class="material-symbols-outlined">schedule</span>
                            <span>3-5 Days</span>
                        </div>
                        <div class="meta-item">
                            <span class="material-symbols-outlined">cached</span>
                            <span>Revisions</span>
                        </div>
                    </div>
                    <div class="service-footer">
                        ${service.price ? `
                            <div class="service-price">
                                <span class="price-label">Starting from</span>
                                <span class="price-value">â‚¹${service.price.toLocaleString()}</span>
                            </div>
                        ` : `
                            <div class="service-price">
                                <span class="price-contact">Contact for Price</span>
                            </div>
                        `}
                        <a href="/services/service/${service.id}" class="btn-view">
                            <span>View</span>
                            <span class="material-symbols-outlined btn-icon">arrow_forward</span>
                        </a>
                    </div>
                </div>
            </article>
        `;
            return card;
        }

        // Render Services
        function renderServices() {
            const grid = document.getElementById('services-grid');
            const empty = document.getElementById('empty-state');

            const startIdx = (currentPage - 1) * servicesPerPage;
            const endIdx = startIdx + servicesPerPage;
            const toShow = filteredServices.slice(startIdx, endIdx);

            grid.innerHTML = '';

            if (toShow.length === 0) {
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            toShow.forEach(service => grid.appendChild(createServiceCard(service)));
            initScrollReveal();
            renderPagination();
        }

        // Select Category
        window.selectCategory = function (btn, category) {
            document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            selectedCategory = category;
            filterServices();
        };

        // Filter Services
        function filterServices() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            filteredServices = allServices.filter(service => {
                const matchSearch = !searchTerm ||
                    service.title.toLowerCase().includes(searchTerm) ||
                    service.description.toLowerCase().includes(searchTerm);
                const matchCategory = selectedCategory === 'all' ||
                    service.category.toLowerCase() === selectedCategory;
                return matchSearch && matchCategory;
            });

            currentPage = 1;
            renderServices();
            updateResultsCount();
        }

        // Update Results Count
        function updateResultsCount() {
            const count = filteredServices.length;
            document.getElementById('results-count').textContent =
                `${count} service${count !== 1 ? 's' : ''} available`;
        }

        // Render Pagination
        function renderPagination() {
            const totalPages = Math.ceil(filteredServices.length / servicesPerPage);
            const container = document.getElementById('pagination');

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = `
            <button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                <span class="material-symbols-outlined">chevron_left</span>
            </button>`;

            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            html += `
            <button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                <span class="material-symbols-outlined">chevron_right</span>
            </button>`;

            container.innerHTML = html;
        }

        // Change Page
        window.changePage = function (page) {
            const totalPages = Math.ceil(filteredServices.length / servicesPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderServices();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // Scroll Reveal
        function initScrollReveal() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) entry.target.classList.add('revealed');
                });
            }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

            document.querySelectorAll('.scroll-reveal').forEach(el => observer.observe(el));
        }

        // Event Listeners
        document.getElementById('search-input').addEventListener('input', filterServices);

        document.getElementById('show-all-btn')?.addEventListener('click', function () {
            document.getElementById('search-input').value = '';
            selectedCategory = 'all';
            document.querySelectorAll('.category-pill').forEach(p => {
                p.classList.remove('active');
                if (p.dataset.category === 'all') p.classList.add('active');
            });
            filteredServices = [...allServices];
            currentPage = 1;
            renderServices();
            updateResultsCount();
        });

        // Initialize
        fetchServices();
        initScrollReveal();
    });
</script>
{% endblock %}